<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Krzysztof Bartoszek, Venelin Mitov" />

<meta name="date" content="2025-09-01" />

<title>Creating a Custom Model in the PCMBase Framework</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">

div.csl-bib-body { }
div.csl-entry {
clear: both;
margin-bottom: 0em;
}
.hanging div.csl-entry {
margin-left:2em;
text-indent:-2em;
}
div.csl-left-margin {
min-width:2em;
float:left;
}
div.csl-right-inline {
margin-left:2em;
padding-left:1em;
}
div.csl-indent {
margin-left: 2em;
}
</style>

<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Creating a Custom Model in the PCMBase
Framework</h1>
<h4 class="author">Krzysztof Bartoszek, Venelin Mitov</h4>
<h4 class="date">2025-09-01</h4>


<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#brownian-motion-with-drift" id="toc-brownian-motion-with-drift">Brownian motion with drift</a></li>
<li><a href="#a-pcmbase-class-for-brownian-motion-with-drift" id="toc-a-pcmbase-class-for-brownian-motion-with-drift">A PCMBase class
for Brownian motion with drift</a></li>
<li><a href="#example-run" id="toc-example-run">Example run</a></li>
<li><a href="#references" id="toc-references">References</a></li>
</ul>
</div>

<!--
# Copyright 2016-2022 Venelin Mitov, Krzysztof Bartoszek
#
# This file is part of PCMBase.
#
# PCMBase is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# PCMBase is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with PCMBase.  If not, see <http://www.gnu.org/licenses/>.
-->
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>The PCMBase package is designed as a computational engine to
calculate the likelihood for a user specified model evolving on a
phylogenetic tree. The package comes with some pre-implemented models,
e.g. Brownian Motion or Ornstein-Uhlenbeck, both allowing for
multivariate correlated evolution. However, the mathematical theory
behind the method for calculating the likelihood <span class="citation">(Mitov et al. 2019)</span> is not limited to these two
models. In fact any stochastic process that belongs to the so-called
GLInv family of models is implementable in PCMBase. From a mathematical
perspective one needs to be able to implement functions that calculate
the compound parameters <span class="math inline">\(\vec{\omega}\)</span>, <span class="math inline">\(\mathbf{\Phi}\)</span> and <span class="math inline">\(\mathbf{V}\)</span>. Furthermore, from the
implementation side one has to be able to handle the model defining
parameters (default values, allowable parametrizations, etc.).</p>
<p>PCMBase’s interface is based on the S3 object system (an excellent
introduction by Hadley Wickham is available at <a href="http://adv-r.had.co.nz/S3.html" class="uri">http://adv-r.had.co.nz/S3.html</a>). Each implemented model
will be an S3 object and below we will describe how users can implement
new model classes by themselves.</p>
</div>
<div id="brownian-motion-with-drift" class="section level1">
<h1>Brownian motion with drift</h1>
<p>We will show how to create one’s own model class with the example of
Brownian motion with drift. The model is a simple generalization of the
Brownian motion model by including a deterministic drift. It is defined
by the stochastic differential equation (SDE) <span class="math display">\[d\vec{X}(t) = \vec{h} dt + \mathbf{\Sigma}_{x} d
W(t),\]</span> where <span class="math inline">\(W(t)\)</span> is the
standard Wiener process, <span class="math inline">\(\vec{h}\)</span> is
a constant <span class="math inline">\(k\)</span>-dimensional vector and
<span class="math inline">\(\mathbf{\Sigma}_{x}\)</span> is a an
upper-triangular matrix with positive diagonal elements. Setting <span class="math inline">\(\vec{h}=\vec{0}\)</span> reduces the model to a
Brownian motion process. The expectation of the process at any time
<span class="math inline">\(t\)</span>, given initial value at <span class="math inline">\(t=0\)</span> is <span class="math inline">\(E[\vec{X}(t)] = \vec{X}(0)+t\vec{h}\)</span> and
the variance is <span class="math inline">\(Var[\vec{X}(t)] =
t\mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}\)</span>. Here, Based on
this we can calculate the the compound parameters <span class="math inline">\(\vec{\omega}\)</span>, <span class="math inline">\(\mathbf{\Phi}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> defining the model in the
GLInv family (Eq. 30, <span class="citation">(Mitov et al. 2019)</span>)
<span class="math display">\[
\vec{\omega} = \vec{h}t,
\]</span> <span class="math display">\[
\mathbf{\Phi} = \mathbf{I},
\]</span> <span class="math display">\[
\mathbf{V} = \mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}t.
\]</span> The above equations hold for any internal node without
measured trait data. For any tip or internal node with available trait
values the variance is given by <span class="math display">\[
\mathbf{V} = \mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}t
+  \mathbf{\Sigma}_{e,x}\mathbf{\Sigma}_{e,x}^{T} +
\mathbf{S}_{e,i}\mathbf{S}_{e,i}^{T},
\]</span> where <span class="math inline">\(\mathbf{\Sigma}_{e,x}\)</span> is a
regime-specific or global upper triangular matrix parameter with a
non-negative diagonal specifying an unknown non-phylogenetic component
of the trait variance covariance matrix (e.g. an unknown measurement
error), and <span class="math inline">\(\mathbf{S}_{e,i}\)</span> is a
species-specific upper triangular matrix with a non-negative diagonal
specifying a known standard error of the measured trait data for each
species.</p>
</div>
<div id="a-pcmbase-class-for-brownian-motion-with-drift" class="section level1">
<h1>A PCMBase class for Brownian motion with drift</h1>
<p>We will now show how to implement the Brownian motion with drift
model in a class called “BM_drift that inherits from the”GaussianPCM”
and “PCM” classes. It is easiest if one takes an .R file from the
PCMBase package that already implements a model class and then modifies
it accordingly. We will work here with the BM.R file (that implements
the BM model). We need to redefine the generic functions of the “PCM”
and “GaussianPCM” classes to suit the Brownian motion with drift model.
We remind the reader that the function name is composed of two parts
separated by the dot. The first part is the generic function, the second
the name of the class in which it is implemented. For example
<code>PCMCond.BM_drift</code> is the <code>PCMCond</code> function’s
instance in the “BM_drift” class.</p>
<ul>
<li><code>PCMParentClasses.BM_drift</code> : function returning the
parental classes. of “BM_drift”:</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>PCMParentClasses.BM_drift <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">&quot;GaussianPCM&quot;</span>, <span class="st">&quot;PCM&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li><code>PCMDescribe.BM_drift</code> : function returning a custom
description of the model.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>PCMDescribe.BM_drift <span class="ot">&lt;-</span> <span class="cf">function</span>(model, ...) {</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="st">&quot;Brownian motion model with drift&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li><code>PCMCond.BM_drift</code> : the key function when implementing a
new model class. This function returns a list with functions for
calculating the <span class="math inline">\(\vec{\omega}\)</span>, <span class="math inline">\(\mathbf{\Phi}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> compound parameters that
define the conditional distribution of the daughter node given the value
of the trait at its parent node (<span class="math inline">\(\vec{x}_{parent}\)</span>. Following <span class="citation">(Mitov et al. 2019)</span> we know that in the GLInv
family a daughter node conditional on its parent is normally distributed
with expectation <span class="math inline">\(\vec{\omega}+\mathbf{\Phi}\vec{x}_{parent}\)</span>
and variance-covariance matrix <span class="math inline">\(\mathbf{V}\)</span>. In particular the <span class="math inline">\(\vec{\omega}\)</span>, <span class="math inline">\(\mathbf{\Phi}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> compound parameters can depend
on time (i.e. the length of the branch from the parental to the daughter
node). In the case of the BM with drift model the <span class="math inline">\(\vec{\omega}=t\cdot \vec{h}\)</span>, <span class="math inline">\(\mathbf{\Phi}\)</span> is the identity matrix and
<span class="math inline">\(\mathbf{V}\)</span> is the same as in the
Brownian motion model (which in itself is a limit of the OU model, hence
the reuse of the PCMConcVOU function).</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>PCMCond.BM_drift <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  tree, model, <span class="at">r =</span> <span class="dv">1</span>, <span class="at">metaI =</span> <span class="fu">PCMInfo</span>(<span class="cn">NULL</span>, tree, model, <span class="at">verbose =</span> verbose),</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="at">verbose=</span><span class="cn">FALSE</span>) {</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  </span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  Sigma_x <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">is.Global</span>(model<span class="sc">$</span>Sigma_x)){<span class="fu">as.matrix</span>(model<span class="sc">$</span>Sigma_x)}</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>         <span class="cf">else</span>{<span class="fu">as.matrix</span>(model<span class="sc">$</span>Sigma_x[,, r])}</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  Sigma <span class="ot">&lt;-</span> Sigma_x <span class="sc">%*%</span> <span class="fu">t</span>(Sigma_x)</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(model<span class="sc">$</span>Sigmae_x)) {</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>    Sigmae_x <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">is.Global</span>(model<span class="sc">$</span>Sigmae_x)){<span class="fu">as.matrix</span>(model<span class="sc">$</span>Sigmae_x)}</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>        <span class="cf">else</span>{<span class="fu">as.matrix</span>(model<span class="sc">$</span>Sigmae_x[,,r])}</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>    Sigmae <span class="ot">&lt;-</span> Sigmae_x <span class="sc">%*%</span> <span class="fu">t</span>(Sigmae_x)</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>    Sigmae <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>  }</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(model<span class="sc">$</span>h_drift)) { </span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>    h_drift <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">is.Global</span>(model<span class="sc">$</span>h_drift)) <span class="fu">as.vector</span>(model<span class="sc">$</span>h_drift) <span class="cf">else</span> model<span class="sc">$</span>h_drift[, r]</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>    h_drift <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">nrow</span>(Sigma_x))</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>  }</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>  V <span class="ot">&lt;-</span> <span class="fu">PCMCondVOU</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(Sigma), <span class="fu">ncol</span>(Sigma)), Sigma, Sigmae)</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>  omega <span class="ot">&lt;-</span> <span class="cf">function</span>(t, edgeIndex, metaI) {</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>    t<span class="sc">*</span>h_drift</span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>  }</span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="cf">function</span>(t, edgeIndex, metaI, <span class="at">e_Ht =</span> <span class="cn">NULL</span>) {</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>    <span class="fu">diag</span>(<span class="fu">nrow</span>(Sigma))</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>  }</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">omega =</span> omega, <span class="at">Phi =</span> Phi, <span class="at">V =</span> V)</span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li><code>PCMDescribeParameters.BM_drift</code> : a function that
returns a list with a custom description of each model parameter.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>PCMDescribeParameters.BM_drift <span class="ot">&lt;-</span> <span class="cf">function</span>(model, ...) {</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="at">X0 =</span> <span class="st">&quot;trait values at the root&quot;</span>,</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="at">h_drift =</span> <span class="st">&quot;drift vector modifying the expectation&quot;</span>,</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    <span class="at">Sigma_x =</span> <span class="st">&quot;Upper triangular factor of the unit-time variance rate&quot;</span>,</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    <span class="at">Sigmae_x =</span> <span class="st">&quot;Upper triangular factor of the non-heritable variance </span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="st">        or the variance of the measurement error&quot;</span>)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li><code>PCMListParameterizations.BM_drift</code> : a function that
returns all possible parametrizations for the implemented model class.
These parametrizations correspond to how each parameter defining the
model can be parametrized. Probably from the perspective of just
calculating the likelihood given some parameters this function does not
seem that useful. However, one should not forget that PCMBase is
designed to be a computational engine providing the likelihood that will
be optimized over some other code. Here, <span class="math inline">\(\vec{X}(0)\)</span> and <span class="math inline">\(\vec{h}\)</span> are vectors
(i.e. “VectorParameter”). The “_AllEqual” parametrization means all the
entries of the vector should be equal. “_Global” means that it is the
same for all regimes (notice that <span class="math inline">\(\vec{X}(0)\)</span> is the value at the root, so
it has to be common for all), “_Omitted” means not present (for <span class="math inline">\(\vec{h}\)</span> this means that the model will
correspond to a Brownian motion with <span class="math inline">\(0\)</span> drift). Finally “_Fixed” means that the
parameter is “known”, i.e. it is not to be optimized over. Matrix
parametrizations are more involved. For example one will not optimize
over a covariance matrix but e.g. over its decomposition as a product of
an upper triangular matrix with its transpose. Here we just have the
<span class="math inline">\(\mathbf{\Sigma}_{x}\)</span> and <span class="math inline">\(\mathbf{\Sigma}_{e,x}\)</span> matrices (however
see the “OU” class for more involved cases with the <span class="math inline">\(H\)</span> matrix). Both of them enter the
likelihood (through <span class="math inline">\(\mathbf{V}\)</span>) as
a product of themselves and their transposition i.e.  <span class="math inline">\(\mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}\)</span>
so decomposition into a triangular matrix (with non-negative diagonal)
suffices for unique identification of the matrix. Note that this
parametrization guarantees that the matrix <span class="math inline">\(\mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}\)</span>
is a symmetric semi- positive-definite matrix. If the diagonal elements
of <span class="math inline">\(\mathbf{\Sigma}_{x}\)</span> are strictly
non-zero <span class="math inline">\(\mathbf{\Sigma}_{x}\mathbf{\Sigma}_{x}^{T}\)</span>
will be positive-definite. A detailed description of the different
possible parametrizations is given in the <a href="https://venelin.github.io/PCMBase/articles/PCMParam.html">The
PCMBase Parametrization API</a> guide.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>PCMListParameterizations.BM_drift <span class="ot">&lt;-</span> <span class="cf">function</span>(model, ...) {</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    <span class="at">X0 =</span> <span class="fu">list</span>(</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>, <span class="st">&quot;_Global&quot;</span>),</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>, <span class="st">&quot;_Fixed&quot;</span>, <span class="st">&quot;_Global&quot;</span>),</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>, <span class="st">&quot;_AllEqual&quot;</span>, <span class="st">&quot;_Global&quot;</span>),</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>, <span class="st">&quot;_Omitted&quot;</span>)),</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>    <span class="at">h_drift =</span> <span class="fu">list</span>(     </span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>),</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>, <span class="st">&quot;_Fixed&quot;</span>),</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>, <span class="st">&quot;_AllEqual&quot;</span>),</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>       <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>, <span class="st">&quot;_Omitted&quot;</span>)),</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>       </span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>    <span class="at">Sigma_x =</span> <span class="fu">list</span>(</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_UpperTriangularWithDiagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>),</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_Diagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>),</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_ScalarDiagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>)),</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>    <span class="at">Sigmae_x =</span> <span class="fu">list</span>(</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_UpperTriangularWithDiagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>),</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_Diagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>),</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_ScalarDiagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>),</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_UpperTriangularWithDiagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>, <span class="st">&quot;_Global&quot;</span>),</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_Diagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>, <span class="st">&quot;_Global&quot;</span>),</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_ScalarDiagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>, <span class="st">&quot;_Global&quot;</span>),</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_Omitted&quot;</span>))</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>  )</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li><code>PCMListDefaultParameterizations.BM_drift</code> : this
function is optional to define but can be useful if only a subset of the
parametrizations defined in the <code>PCMListParametrizations</code>
function will actually be used in practice.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>PCMListDefaultParameterizations.BM_drift <span class="ot">&lt;-</span> <span class="cf">function</span>(model, ...) {</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    <span class="at">X0 =</span> <span class="fu">list</span>(</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>, <span class="st">&quot;_Global&quot;</span>),</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>, <span class="st">&quot;_Omitted&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    ),</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>    <span class="at">h_drift =</span> <span class="fu">list</span>(     </span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;VectorParameter&quot;</span>)),</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>       </span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>    <span class="at">Sigma_x =</span> <span class="fu">list</span>(</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>        <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_UpperTriangularWithDiagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>),</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>        <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_Diagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>),</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>        <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_ScalarDiagonal&quot;</span>, <span class="st">&quot;_WithNonNegativeDiagonal&quot;</span>)</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>      ),</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    <span class="at">Sigmae_x =</span> <span class="fu">list</span>(</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">&quot;MatrixParameter&quot;</span>, <span class="st">&quot;_Omitted&quot;</span>))</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>  )</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li><code>PCMSpecify.BM_drift</code> : generate default model
parameters. Notice that here we obtain a singular model with 0 mean and
0 variance.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>PCMSpecify.BM_drift <span class="ot">&lt;-</span> <span class="cf">function</span>(model, ...) {</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  spec <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="at">X0 =</span> <span class="fu">structure</span>(<span class="fl">0.0</span>, <span class="at">class =</span> <span class="fu">c</span>(<span class="st">&#39;VectorParameter&#39;</span>, <span class="st">&#39;_Global&#39;</span>),</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>                   <span class="at">description =</span> <span class="st">&#39;trait values at the root&#39;</span>),</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>    <span class="at">h_drift =</span> <span class="fu">structure</span>(<span class="fl">0.0</span>, <span class="at">class =</span> <span class="fu">c</span>(<span class="st">&#39;VectorParameter&#39;</span>),</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>                   <span class="at">description =</span> <span class="st">&#39;drift vector modifying the expectation&#39;</span>),</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>    <span class="at">Sigma_x =</span> <span class="fu">structure</span>(<span class="fl">0.0</span>, <span class="at">class =</span> <span class="fu">c</span>(<span class="st">&#39;MatrixParameter&#39;</span>, <span class="st">&#39;_UpperTriangularWithDiagonal&#39;</span>, </span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>                    <span class="st">&#39;_WithNonNegativeDiagonal&#39;</span>),</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>                        <span class="at">description =</span> <span class="st">&#39;Cholesky factor of the unit-time variance rate&#39;</span>),</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    <span class="at">Sigmae_x =</span> <span class="fu">structure</span>(<span class="fl">0.0</span>, <span class="at">class =</span> <span class="fu">c</span>(<span class="st">&#39;MatrixParameter&#39;</span>, <span class="st">&#39;_UpperTriangularWithDiagonal&#39;</span>,</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>                    <span class="st">&#39;_WithNonNegativeDiagonal&#39;</span>),</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>                         <span class="at">description =</span> <span class="st">&#39;Upper triangular factor of the non-heritable variance </span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="st">                                or the variance of the measurement error&#39;</span>))</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>  <span class="fu">attributes</span>(spec) <span class="ot">&lt;-</span> <span class="fu">attributes</span>(model)</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(<span class="fu">names</span>(spec))) <span class="fu">names</span>(spec) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;X0&#39;</span>, <span class="st">&#39;h_drift&#39;</span>, <span class="st">&#39;Sigma_x&#39;</span>, <span class="st">&#39;Sigmae_x&#39;</span>)</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">sapply</span>(spec, is.Transformable))) <span class="fu">class</span>(spec) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">class</span>(spec), <span class="st">&#39;_Transformable&#39;</span>)</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>  spec</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="example-run" class="section level1">
<h1>Example run</h1>
<p>Now that we have defined all the code necessary for the class let us
demonstrate it. After running all the above code defining the “BM_drift”
class we create a model instance. We do this for a two regimes
model.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">1</span>) <span class="do">## root state</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="do">## in regime a traits evolve independently</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>a.Sigma_x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="fl">1.6</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">2.4</span>, <span class="fl">0.0</span>),<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">2.0</span>))</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="do">## no jumps at the end of a branch</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>a.Sigmae_x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>))</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>a.h_drift<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>)</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="do">## in regime b evolution is correlated</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>b.Sigma_x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="fl">1.6</span>, <span class="fl">0.3</span>, <span class="fl">0.3</span>), <span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>),<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">2.0</span>))</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a><span class="do">## no jumps at the end of a branch</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>b.Sigmae_x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fu">c</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>))</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>b.h_drift<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>Sigma_x <span class="ot">&lt;-</span> <span class="fu">PCMParamBindRegimeParams</span>(<span class="at">a =</span> a.Sigma_x, <span class="at">b =</span> b.Sigma_x)</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>Sigmae_x <span class="ot">&lt;-</span> <span class="fu">PCMParamBindRegimeParams</span>(<span class="at">a =</span> a.Sigmae_x, <span class="at">b =</span> b.Sigmae_x)</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>h_drift <span class="ot">&lt;-</span> <span class="fu">PCMParamBindRegimeParams</span>(<span class="at">a =</span> a.h_drift, <span class="at">b =</span> b.h_drift)</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>PCMBase_model_BM_drift <span class="ot">&lt;-</span> <span class="fu">PCM</span>(<span class="st">&quot;BM_drift&quot;</span>, <span class="at">k =</span> <span class="dv">3</span>, <span class="at">regimes =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>),</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>                              <span class="at">params =</span> <span class="fu">list</span>(<span class="at">X0 =</span> X0,<span class="at">h_drift =</span> h_drift[,,<span class="at">drop=</span><span class="cn">FALSE</span>],</span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>                                            <span class="at">Sigma_x =</span> Sigma_x[,,,<span class="at">drop=</span><span class="cn">FALSE</span>],<span class="at">Sigmae_x =</span> Sigmae_x[,,,<span class="at">drop=</span><span class="cn">FALSE</span>]))</span></code></pre></div>
<p>Now we simulate a random phylogeny using the same example code as in
the <a href="https://venelin.github.io/PCMBase/articles/PCMBase.html">Getting
started</a> guide.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># make results reproducible</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>, <span class="at">kind =</span> <span class="st">&quot;Mersenne-Twister&quot;</span>, <span class="at">normal.kind =</span> <span class="st">&quot;Inversion&quot;</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co"># number of regimes</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co"># number of extant tips</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>tree.a <span class="ot">&lt;-</span> <span class="fu">PCMTree</span>(<span class="fu">rtree</span>(<span class="at">n=</span>N))</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="fu">PCMTreeSetLabels</span>(tree.a)</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="fu">PCMTreeSetPartRegimes</span>(tree.a, <span class="at">part.regime =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">101</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;a&quot;</span>), <span class="at">setPartition =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>lstDesc <span class="ot">&lt;-</span> <span class="fu">PCMTreeListDescendants</span>(tree.a)</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>splitNode <span class="ot">&lt;-</span> <span class="fu">names</span>(lstDesc)[<span class="fu">which</span>(<span class="fu">sapply</span>(lstDesc, length) <span class="sc">&gt;</span> N<span class="sc">/</span><span class="dv">2</span> <span class="sc">&amp;</span> <span class="fu">sapply</span>(lstDesc, length) <span class="sc">&lt;</span> <span class="dv">2</span><span class="sc">*</span>N<span class="sc">/</span><span class="dv">3</span>)][<span class="dv">1</span>]</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>tree.ab <span class="ot">&lt;-</span> <span class="fu">PCMTreeInsertSingletons</span>(</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>  tree.a, <span class="at">nodes =</span> <span class="fu">as.integer</span>(splitNode), </span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>  <span class="at">positions =</span> <span class="fu">PCMTreeGetBranchLength</span>(tree.a, <span class="fu">as.integer</span>(splitNode))<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a><span class="fu">PCMTreeSetPartRegimes</span>(</span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>  tree.ab,</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>  <span class="at">part.regime =</span> <span class="fu">structure</span>(<span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>), <span class="at">names =</span> <span class="fu">as.character</span>(<span class="fu">c</span>(N<span class="sc">+</span><span class="dv">1</span>, splitNode))), </span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>  <span class="at">setPartition =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>palette <span class="ot">&lt;-</span> <span class="fu">PCMColorPalette</span>(<span class="dv">2</span>, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>))</span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a><span class="co"># Plot the tree with branches colored according to the regimes.</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a><span class="co"># The following code works correctly only if the ggtree package is installed, </span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a><span class="co"># which is not on CRAN.</span></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>plTree <span class="ot">&lt;-</span> <span class="fu">PCMTreePlot</span>(tree.ab)</span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">requireNamespace</span>(<span class="st">&quot;ggtree&quot;</span>)) {</span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a>  plTree <span class="ot">&lt;-</span> plTree <span class="sc">+</span> ggtree<span class="sc">::</span><span class="fu">geom_nodelab</span>(<span class="at">size =</span> <span class="dv">2</span>)</span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>}</span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a>plTree</span></code></pre></div>
<p>We simulate the traits using PCMBase’s functionality.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>mData<span class="ot">&lt;-</span><span class="fu">PCMSim</span>(tree.ab, PCMBase_model_BM_drift, X0)[,<span class="dv">1</span><span class="sc">:</span>N] <span class="do">## we only want the tip data</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="do">## </span><span class="al">NOTE</span><span class="do"> that observations from different species are in the columns NOT in the rows as </span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="do">## in other software</span></span></code></pre></div>
<p>Finally we calculate the likelihood under the BM with drift
model.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>log_lik<span class="ot">&lt;-</span> <span class="fu">PCMLik</span>(mData, tree.ab, PCMBase_model_BM_drift)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="fu">print</span>(log_lik[<span class="dv">1</span>]) <span class="do">## we just want to print the log-likelihood without the attributes</span></span></code></pre></div>
<p>If PCMBase is used as a computational engine for some inference
package, then the above code can be one way of obtaining the likelihood
under a “GaussianPCM” model object. However, in such a setup it is
recommended to use the mechanism of creating a likelihood function for a
particular dataset through PCMCreateLikelihood. This will speed up the
calculations as it avoids re-creating some internal data objects for the
tree every time the likelihood value is required. One just needs to
update the parameters to obtain a new likelihood value.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="do">## create an vector of appropriate length to store the vectorized model parameters</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>v_param <span class="ot">&lt;-</span> <span class="fu">double</span>(<span class="fu">PCMParamCount</span>(PCMBase_model_BM_drift))</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co"># load the current model parameters into param</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="fu">PCMParamLoadOrStore</span>(PCMBase_model_BM_drift, v_param, <span class="at">offset=</span><span class="dv">0</span>, <span class="at">load=</span><span class="cn">FALSE</span>)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="fu">print</span>(v_param)</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="do">## now create a likelihood function for the particular model and observed data</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>likFun <span class="ot">&lt;-</span> <span class="fu">PCMCreateLikelihood</span>(mData, tree.ab, PCMBase_model_BM_drift)</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>log_lik_from_likFun<span class="ot">&lt;-</span><span class="fu">likFun</span>(v_param)</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="fu">print</span>(log_lik_from_likFun[<span class="dv">1</span>])</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="fu">print</span>(log_lik_from_likFun[<span class="dv">1</span>]<span class="sc">==</span>log_lik[<span class="dv">1</span>])</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="co"># modify slightly the model parameters</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>v_param_2 <span class="ot">&lt;-</span> <span class="fu">jitter</span>(v_param)</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a><span class="fu">print</span>(v_param_2)</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a><span class="co"># set the new parameter vector</span></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>PCMBase_model_BM_drift_2<span class="ot">&lt;-</span>PCMBase_model_BM_drift</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a><span class="fu">PCMParamLoadOrStore</span>(PCMBase_model_BM_drift_2, v_param_2, <span class="at">offset =</span> <span class="dv">0</span>, <span class="at">load=</span><span class="cn">TRUE</span>)</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a><span class="fu">print</span>(PCMBase_model_BM_drift_2)</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>log_lik_from_likFun_2<span class="ot">&lt;-</span><span class="fu">likFun</span>(v_param_2)</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a><span class="fu">print</span>(log_lik_from_likFun_2[<span class="dv">1</span>])</span></code></pre></div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Mitov:2018fl" class="csl-entry">
Mitov, Venelin, Krzysztof Bartoszek, Georgios Asimomitis, and Tanja
Stadler. 2019. <span>“<span class="nocase">Fast likelihood calculation
for multivariate Gaussian phylogenetic models with
shifts</span>.”</span> <em>Theor. Popul. Biol.</em>, December. <a href="https://doi.org/10.1016/j.tpb.2019.11.005">https://doi.org/10.1016/j.tpb.2019.11.005</a>.
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
